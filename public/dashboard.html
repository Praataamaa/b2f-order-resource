<!DOCTYPE html>
<html>
<head>
  <title>Order Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 1100px;
      padding: 30px;
    }
    .card {
      background: #1c1c1c;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
    }
    h2, h3 {
      margin-top: 0;
    }
    select, input, button {
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin: 5px 0;
      font-size: 14px;
    }
    select, input {
      background: #2a2a2a;
      color: #fff;
      width: 100%;
    }
    button {
      background: #4f8cff;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      opacity: 0.85;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .remove-btn {
      background: none;
      border: none;
      color: #ff4d4d;
      cursor: pointer;
      margin-left: 8px;
    }
    .total {
      font-weight: bold;
      margin-top: 10px;
    }
    .order-box {
      background: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* =======================
       ORDER HISTORY TABLE STYLES
    ======================== */
    table.order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: fixed;
    }
    table.order-table th, table.order-table td {
      padding: 16px 18px;
      text-align: left;
      vertical-align: top;
    }
    table.order-table th {
      background: #222;
      font-weight: 600;
      border-bottom: 2px solid #333;
    }
    table.order-table td {
      border-bottom: 1px solid #2a2a2a;
    }
    table.order-table th:nth-child(1), table.order-table td:nth-child(1) { width: 120px; }
    table.order-table th:nth-child(2), table.order-table td:nth-child(2) { width: 45%; white-space: normal; }
    table.order-table th:nth-child(3), table.order-table td:nth-child(3) { width: 140px; }
    table.order-table th:nth-child(4), table.order-table td:nth-child(4) { width: 200px; }
    table.order-table tbody tr { background: #1a1a1a; }
    table.order-table tbody tr:not(:last-child) { border-bottom: 15px solid #111; }
    table.order-table tbody tr:hover { background: #222; }

    /* =======================
       TABS STYLES
    ======================== */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tab {
      padding: 8px 16px;
      background: #2a2a2a;
      cursor: pointer;
      border-radius: 6px;
    }
    .tab.active {
      background: #4f8cff;
    }
  </style>
</head>
<body>
  <div class="container">

    <h2>Order Dashboard</h2>

    <div class="grid">

      <!-- ORDER SECTION -->
      <div class="card">
        <h3>New Order</h3>

        <!-- TABS -->
        <div class="tabs">
          <div class="tab active" data-category="weapon">Weapon</div>
          <div class="tab" data-category="ammo">Ammo & Vest</div>
          <div class="tab" data-category="attachment">Attachment</div>
          <div class="tab" data-category="drug">Drug</div>
        </div>

        <select id="itemSelect"></select>
        <input id="qty" type="number" placeholder="Quantity">
        <button onclick="addToCart()">Add to Cart</button>

        <div id="cartItems"></div>
        <div class="total">Total: <span id="totalPrice">$0</span></div>

        <button onclick="submitOrder()">Submit Order</button>
      </div>

      <!-- LEADER PANEL -->
      <div class="card" id="leaderPanel"></div>

    </div>

    <!-- ORDER HISTORY -->
    <div class="card">
      <h3>Order History</h3>
      <button onclick="exportExcel()">Export Orders (Excel)</button>
      <table id="orderTable" class="order-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Item</th>
            <th>Total</th>
            <th>Time (UTC+7)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button onclick="logout()">Logout</button>

  </div>

  <script>
    let cart = [];
    let selectedCategory = "weapon";
    let allItems = [];

    const username = localStorage.getItem("username");
    const rawRole = localStorage.getItem("role");
    const role = rawRole ? rawRole.toLowerCase().trim() : null;

    if (!username) {
      window.location.href = "/login.html";
    }

    // Load items from DB
    async function loadItems() {
      const res = await fetch("/items");
      allItems = await res.json();

      // Debugging: log the items to check their structure
      console.log("Fetched Items:", allItems);

      renderItemSelect();
    }

    function renderItemSelect() {
      const select = document.getElementById("itemSelect");
      select.innerHTML = "";

      // Filter items based on selected category and ensure category exists
      const filtered = allItems.filter(i => {
        // Check if category exists and is a string
        if (!i.category || typeof i.category !== 'string') {
          console.error("Item missing category:", i);
          return false;  // Exclude items missing category
        }
        return i.category.toLowerCase() === selectedCategory;
      });

      if (filtered.length === 0) {
        console.log("No items found for category:", selectedCategory);
      }

      filtered.forEach(item => {
        const option = document.createElement("option");
        option.value = JSON.stringify(item);
        option.textContent = `${item.name} - $${item.price.toLocaleString()}`;
        select.appendChild(option);
      });
    }

    // Handle tab switching
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        selectedCategory = tab.dataset.category;
        renderItemSelect();  // Re-render the item select dropdown
      });
    });

    function addToCart() {
      const selected = document.getElementById("itemSelect").value;
      const qty = parseInt(document.getElementById("qty").value);

      if (!selected || !qty || qty <= 0) {
        alert("Invalid quantity");
        return;
      }

      const item = JSON.parse(selected);
      const total = item.price * qty;

      cart.push({
        name: item.name,
        price: item.price,
        qty,
        total
      });

      document.getElementById("qty").value = "";
      renderCart();
    }

    function removeItem(index) {
      cart.splice(index, 1);
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById("cartItems");
      container.innerHTML = "";
      let grandTotal = 0;

      cart.forEach((item, index) => {
        grandTotal += item.total;

        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <span>${item.name} x${item.qty}</span>
          <span>
            $${item.total.toLocaleString()}
            <button class="remove-btn"
              onclick="removeItem(${index})">✕</button>
          </span>
        `;
        container.appendChild(div);
      });

      document.getElementById("totalPrice").innerText =
        "$" + grandTotal.toLocaleString();
    }

    async function submitOrder() {
      if (cart.length === 0) {
        alert("Cart empty");
        return;
      }

      await fetch("/order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, cart })
      });

      cart = [];
      renderCart();
      loadOrders();
    }

    async function loadOrders() {
      const res = await fetch(`/orders/${username}/${role}`);
      const data = await res.json();

      const tbody = document.querySelector("#orderTable tbody");
      tbody.innerHTML = "";

      data.forEach(orderGroup => {
        const row = document.createElement("tr");
        const formattedItems = orderGroup.items.map(i => "• " + i).join("<br>");
        row.innerHTML = `
          <td>${orderGroup.username}</td>
          <td style="white-space: normal;">${formattedItems}</td>
          <td>$${orderGroup.total.toLocaleString()}</td>
          <td>${orderGroup.time}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderLeaderPanel() {
      const panel = document.getElementById("leaderPanel");

      if (role !== "leader") {
        panel.style.display = "none";
        return;
      }

      panel.style.display = "block";

      panel.innerHTML = `
      <h3>User Management</h3>
      <input id="newUser" placeholder="Username">
      <input id="newPass" type="password" placeholder="Password">
      <select id="newRole">
        <option value="member">Member</option>
        <option value="leader">Leader</option>
      </select>
      <button onclick="createUser()">Create User</button>
      `;
    }

    async function createUser() {
      const newUsername = document.getElementById("newUser").value.trim();
      const newPassword = document.getElementById("newPass").value.trim();
      const newRole = document.getElementById("newRole").value;

      if (!newUsername || !newPassword) {
        alert("Fill all fields");
        return;
      }

      await fetch("/create-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: newUsername,
          password: newPassword,
          role: newRole
        })
      });

      alert("User created successfully");
    }

    function exportExcel() {
      window.location.href = `/export/${username}/${role}`;
    }

    function logout() {
      localStorage.clear();
      window.location.href = "/login.html";
    }

    window.onload = function () {
      loadItems();
      loadOrders();
      renderLeaderPanel();
    }
  </script>
</body>
</html>
